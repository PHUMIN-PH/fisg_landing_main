<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <title>ลงทะเบียนแคมเปญ</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.1/css/bootstrap.min.css" integrity="sha512-siwe/oXMhSjGCwLn+scraPOWrJxHlUgMBMZXdPe2Tnk3I0x3ESCoLz7WZ5NTH6SZrywMY+PB1cjyqJ5jAluCOg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.9.1/font/bootstrap-icons.min.css" integrity="sha512-5PV92qsds/16vyYIJo3T/As4m2d8b6oWYfoqV+vtizRB6KhF1F9kYzWzQmsO6T3z3QG2Xdhrx7FQ+5R1LiQdUA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" defer></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f7fa;
    }

    .container {
      max-width: 420px;
      margin: 60px auto;
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    h2 {
      text-align: center;
      margin-bottom: 24px;
    }

    label {
      display: block;
      margin-top: 16px;
      font-weight: bold;
    }

    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .checkbox {
      margin-top: 16px;
    }

    button {
      width: 100%;
      margin-top: 20px;
      padding: 12px;
      background: #111;
      color: #fff;
      border: none;
      border-radius: 24px;
      cursor: pointer;
      font-size: 16px;
    }

    button:disabled {
      background: #aaa;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>ลงทะเบียนแคมเปญ</h2>

    <label>อีเมล</label>
    <input type="email" id="email" placeholder="example@email.com" />

    <label>รหัสผ่าน</label>
    <input type="password" id="password" placeholder="******" />
     <div class="cf-turnstile" data-sitekey="1x00000000000000000000AA" data-theme="light"></div>
    <div class="checkbox">
      <input type="checkbox" id="accept" />
      <label for="accept">
        ฉันเข้าใจว่าการเข้าร่วมกิจกรรมนี้จะทำให้เสียคะแนนสะสมทั้งหมด
      </label>
    </div>

    <button id="submitBtn">ฉันเห็นด้วยและส่งต่อ</button>
  </div>

  <script>
    const btn = document.getElementById('submitBtn');

    btn.addEventListener('click', async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const accept = document.getElementById('accept').checked;
      // const token = document.getElementsByName("cf-turnstile-response").value;
      const tokenInput = document.querySelector('input[name="cf-turnstile-response"]');
      const token = tokenInput ? tokenInput.value : '';
      const eventName = "deposit-and-trade-to-win";

      if (!email || !password) {
        alert('กรุณากรอก email และรหัสผ่าน');
        return;
      }

      if (!accept) {
        alert('กรุณายอมรับเงื่อนไข');
        return;
      }

      if (!token) {
        alert('กรุณายืนยันตัวตน (captcha)');
        return;
      }

      btn.disabled = true;

      try {
        const res = await fetch('/api/register/deposit-and-trade-to-win', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email : email, 
            password : password,
            event_name : eventName,
            'cf-turnstile-response' :token }),
        });

        const data = await res.json();

        // handle status จาก backend
        if (data.status === 'INVALID_USER') {
          alert('ยังไม่มีบัญชี กรุณาสมัครสมาชิก');
        } else if (data.status === 'INVALID_CREDENTIAL') {
          alert('อีเมลหรือรหัสผ่านไม่ถูกต้อง');
        } else if (data.status === 'DUPLICATE_REGISTERED') {
          alert('คุณเคยลงทะเบียนแคมเปญนี้แล้ว');
        } else if (data.status === 'REGISTERED') {
          alert('ลงทะเบียนสำเร็จ');
          // window.location.href = '/success.html';
        } else {
          alert('เกิดข้อผิดพลาด');
        }
      } catch (err) {
        alert('เชื่อมต่อเซิร์ฟเวอร์ไม่ได้');
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>

</html>